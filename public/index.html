<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Laravel 11 Reverb WebSocket Demo</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Pusher å®˜æ–¹ CDNï¼ˆEcho ä¾èµ–ç”¨ï¼‰ -->
    <!--<script src="https://js.pusher.com/8.2/pusher.min.js"></script>
    &lt;!&ndash; 100% å¯ç”¨çš„ Laravel Echo CDNï¼ˆå®˜æ–¹æ¨èçš„ç¨³å®šç‰ˆï¼‰ &ndash;&gt;
    <script src="https://cdn.jsdelivr.net/npm/laravel-echo@1/dist/echo.iife.js"></script>-->

    <!-- 1. åŠ è½½ä¸€ä¸ªä¸ Reverb å…¼å®¹çš„ Pusher åè®®åº“ (è¿™æ˜¯ä¸´æ—¶æ–¹æ¡ˆ) -->
    <script src="https://cdn.jsdelivr.net/npm/pusher-js@8.2.0/dist/web/pusher.min.js"></script>
    <!-- 2. åŠ è½½ Laravel Echo -->
    <script src="https://cdn.jsdelivr.net/npm/laravel-echo@1/dist/echo.iife.js"></script>

    <style>
        body { font-family: Arial; padding: 20px; }
        #log { background: #000; color: #0f0; padding: 10px; height: 300px; overflow-y: auto; }
    </style>

</head>
<body>

<h2>Laravel 11 + Reverb WebSocket Demo</h2>

<div>
    <input type="text" id="email" placeholder="email" value="test@test.com">
    <input type="password" id="password" placeholder="password" value="123456">
    <button id="login">ç™»å½•å¹¶å¯åŠ¨ WebSocket</button>
    <button id="sendMsgBtn">Send Push to user 1</button>
</div>

<h3>å®æ—¶æ¶ˆæ¯ï¼š</h3>
<div id="log"></div>

<script>
    function log(msg) {
        $("#log").append("<div>" + msg + "</div>");
    }

    let token = null;
    let userId = null;

    $("#login").click(async function () {
        let email = $("#email").val();
        let password = $("#password").val();

        const res = await fetch("http://localhost:8000/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
        });

        const data = await res.json();

        if (!data.token) {
            alert("ç™»å½•å¤±è´¥");
            return;
        }

        token = data.token;
        userId = data.user.id;

        log("âœ… ç™»å½•æˆåŠŸï¼");
        log("ç”¨æˆ· ID = " + userId);

        connectWebSocket();
    });

    $('#sendMsgBtn').click(async function(){
        if (!token) { alert('è¯·å…ˆç™»å½•'); return; }
        const res = await fetch('/api/push', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({user_id: 1, msg: 'Hello from front-end'})
        });
        const d = await res.json();
        log('push è¿”å›: ' + JSON.stringify(d));
    });


    function connectWebSocket() {

        log("ğŸ”Œ åˆå§‹åŒ–è¿æ¥ä¸­...")

        let options = {
            broadcaster: 'pusher',
            key: 'uibue7bno0s6yitvqexw',
            cluster: 'local',
            wsHost: '127.0.0.1',
            wsPort: 8080,
            forceTLS: false,
            auth: {
                headers: {
                    Authorization: 'Bearer ' + token
                }
            }
        };
        console.log('å‚æ•°'+ options);
        window.Echo = new window.Echo(options);

        // ===== æ–°å¢ï¼šè·å–å†…éƒ¨çš„ Pusher å®ä¾‹å¹¶æ‰‹åŠ¨è®¢é˜… =====
        const pusher = window.Echo.connector.pusher;
        const channelName = 'private-user.' + userId; // æ³¨æ„ï¼šè¿™é‡Œé¢‘é“åå‰å¿…é¡»åŠ ä¸Š 'private-'

        // è®¢é˜…é¢‘é“
        const channel = pusher.subscribe(channelName);

        // ç»‘å®šè¿æ¥æˆåŠŸäº‹ä»¶
        channel.bind('pusher:subscription_succeeded', () => {
            console.log('âœ… ç§æœ‰é¢‘é“è®¢é˜…æˆåŠŸï¼Œè®¤è¯å·²é€šè¿‡ï¼');
        });

        // ç»‘å®šè‡ªå®šä¹‰äº‹ä»¶
        channel.bind('UserNotification', (e) => {
            log("ğŸ“© æ”¶åˆ°æ¨é€: " + JSON.stringify(e));
        });

        // ç»‘å®šè®¢é˜…é”™è¯¯äº‹ä»¶
        channel.bind('pusher:subscription_error', (status) => {
            console.error('âŒ ç§æœ‰é¢‘é“è®¢é˜…å¤±è´¥:', status);
        });

        log("æµ‹è¯•å·²ç»é“¾æ¥...")

        // ç›‘å¬ç§æœ‰é¢‘é“
        /*window.Echo.channel('test')
            .listen('UserNotification', (e) => {
                log("ğŸ“© æ”¶åˆ°å…¬å…±æ¨é€: " + JSON.stringify(e));
            });*/
        window.Echo.private("user." + userId)
            .listen("UserNotification", (e) => {
                log("ğŸ“© æ”¶åˆ°æ¨é€: " + JSON.stringify(e));
            }).error((err) => {
            console.error("è®¢é˜…é”™è¯¯", err);
        });

        log("ğŸ§ WebSocket ç›‘å¬å·²å¯åŠ¨ï¼šprivate:user." + userId);

    }
</script>

</body>
</html>
